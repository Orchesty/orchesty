version: '3.3'
services:
        logstash:
                image: 'dkr.hanaboso.net/pipes/pipes/logstash:dev'
                environment:
                        MONGO_HOST: mongo
                        MONGO_DATABASE: demo
                        MONGO_COLLECTION: Logs
                        LS_JAVA_OPTS: '-Xms512m -Xmx512m'
        telegraf:
                image: 'dkr.hanaboso.net/pipes/pipes/rabbitmq-telegraf:dev'
                environment:
                        METRICS_SERVICE: mongo
                        METRICS_HOST: mongo
                        METRICS_PORT: 27017
        batch:
                image: 'dkr.hanaboso.net/pipes/demo/monolith:dev'
                command: 'bin/console rabbit_mq:consumer:batch'
                environment:
                        BACKEND_HOST: '${BACKEND_URL}/'
                        ELASTIC_HOST: elasticsearch
                        ELASTIC_INDEX: logstash-2018.01.31
                        PHP_FPM_MAX_REQUESTS: 5000
                        PHP_WEBROOT: /var/www/pipes/clients/demo/pipes-api/public
                        SMTP_USER: dev.email.hb@gmail.com
                        SMTP_PASSWORD: jVME2RkX9xyYhj9v
                        METRICS_HOST: mongo
                        METRICS_PORT: 27017
                        METRICS_SERVICE: mongo
        batch-connector:
                image: 'dkr.hanaboso.net/pipes/demo/monolith:dev'
                command: 'bin/console rabbit_mq:consumer:batch-connector'
                environment:
                        BACKEND_HOST: '${BACKEND_URL}/'
                        ELASTIC_HOST: elasticsearch
                        ELASTIC_INDEX: logstash-2018.01.31
                        PHP_FPM_MAX_REQUESTS: 5000
                        PHP_WEBROOT: /var/www/pipes/clients/demo/pipes-api/public
                        SMTP_USER: dev.email.hb@gmail.com
                        SMTP_PASSWORD: jVME2RkX9xyYhj9v
                        METRICS_HOST: mongo
                        METRICS_PORT: 27017
                        METRICS_SERVICE: mongo
        long-running-node:
                image: 'dkr.hanaboso.net/pipes/demo/monolith:dev'
                command: 'bin/console rabbit_mq:consumer:long-running-node'
                environment:
                        BACKEND_HOST: '${BACKEND_URL}/'
                        ELASTIC_HOST: elasticsearch
                        ELASTIC_INDEX: logstash-2018.01.31
                        PHP_FPM_MAX_REQUESTS: 5000
                        PHP_WEBROOT: /var/www/pipes/clients/demo/pipes-api/public
                        SMTP_USER: dev.email.hb@gmail.com
                        SMTP_PASSWORD: jVME2RkX9xyYhj9v
                        METRICS_HOST: mongo
                        METRICS_PORT: 27017
                        METRICS_SERVICE: mongo
        status-service:
                image: 'dkr.hanaboso.net/pipes/demo/monolith:dev'
                command: 'bin/console rabbit_mq:consumer:status-service'
                environment:
                        BACKEND_HOST: '${BACKEND_URL}/'
                        ELASTIC_HOST: elasticsearch
                        ELASTIC_INDEX: logstash-2018.01.31
                        PHP_FPM_MAX_REQUESTS: 5000
                        PHP_WEBROOT: /var/www/pipes/clients/demo/pipes-api/public
                        SMTP_USER: dev.email.hb@gmail.com
                        SMTP_PASSWORD: jVME2RkX9xyYhj9v
                        METRICS_HOST: mongo
                        METRICS_PORT: 27017
                        METRICS_SERVICE: mongo
        multi-probe:
                image: 'dkr.hanaboso.net/pipes/pipes/multi-probe:dev'
                environment:
                        REDIS_HOST: redis
                        REDIS_PORT: 6379
                        REDIS_PASS: ''
                        REDIS_DB: 0
        multi-counter:
                image: 'dkr.hanaboso.net/pipes/pipes/pf-bridge:dev'
                environment:
                        RABBITMQ_HOST: rabbitmq
                        RABBITMQ_PORT: 5672
                        RABBITMQ_USER: guest
                        RABBITMQ_PASS: guest
                        RABBITMQ_VHOST: /
                        REDIS_HOST: redis
                        REDIS_PORT: 6379
                        REDIS_PASS: ''
                        REDIS_DB: 0
                        COUNTER_PREFETCH: 100
                        METRICS_HOST: mongo
                        METRICS_PORT: 27017
                        METRICS_SERVICE: mongo
                command: './dist/src/bin/pipes.js start multi_counter'
        starting-point:
                image: 'dkr.hanaboso.net/pipes/pipes/starting-point:dev'
                environment:
                        APP_DEBUG: 'false'
                        MONGO_HOSTNAME: mongo
                        MONGO_DATABASE: demo
                        RABBIT_COUNTER_QUEUE_DURABLE: 'true'
                        RABBIT_QUEUE_DURABLE: 'true'
                        RABBIT_DELIVERY_MODE: 2
                        APP_CLEANUP_TIME: 300
                        METRICS_HOST: mongo
                        METRICS_PORT: 27017
                        METRICS_SERVICE: mongo
        repeater:
                image: 'dkr.hanaboso.net/pipes/pipes/pf-bridge:dev'
                command: './dist/src/bin/pipes.js start repeater'
                environment:
                        RABBITMQ_HOST: rabbitmq
                        RABBITMQ_PORT: 5672
                        RABBITMQ_USER: guest
                        RABBITMQ_PASS: guest
                        RABBITMQ_VHOST: /
                        MONGO_HOST: mongo
                        REPEATER_CHECK_TIMEOUT: 5000
                        METRICS_HOST: mongo
                        METRICS_PORT: 27017
                        METRICS_SERVICE: mongo
        monolith-api:
                image: 'dkr.hanaboso.net/pipes/demo/monolith:dev'
                environment:
                        BACKEND_HOST: '${BACKEND_URL}/'
                        ELASTIC_HOST: elasticsearch
                        ELASTIC_INDEX: logstash-2018.01.31
                        METRICS_HOST: mongo
                        METRICS_PORT: 27017
                        METRICS_SERVICE: mongo
                        PHP_WEBROOT: /var/www/pipes/clients/demo/pipes-api/public
                        SMTP_USER: dev.email.hb@gmail.com
                        SMTP_PASSWORD: jVME2RkX9xyYhj9v
        notification-sender-api:
                image: 'dkr.hanaboso.net/pipes/notification-sender:dev'
        notification-sender-consumer:
                image: 'dkr.hanaboso.net/pipes/notification-sender:master'
                environment:
                        MONGO_HOST: mongo
        topology-api:
                image: 'dkr.hanaboso.net/pipes/pipes/topology-api-v1:dev'
                environment:
                        DEPLOYMENT_PREFIX: '${DEPLOYMENT_PREFIX}'
                        GENERATOR_NETWORK: '${DEPLOYMENT_PREFIX}_default'
                        GENERATOR_MODE: swarm
                        GENERATOR_PATH: /tmp
                        MONGO_HOST: mongo
                        MONGO_DATABASE: demo
                        RABBITMQ_HOST: rabbitmq
                volumes:
                        - '/var/run/docker.sock:/var/run/docker.sock'
        frontend:
                image: 'dkr.hanaboso.net/pipes/pipes/frontend:dev'
                environment:
                        BACKEND_URL: '${BACKEND_URL}'
                        FRONTEND_URL: '${BACKEND_URL}'
                        PHP_WEBROOT: /var/www/html/public
                ports:
                        - '${PUBLISH_HTTP_PORT}:80'
        stream:
                image: 'dkr.hanaboso.net/pipes/pipes/stream:dev'
                environment:
                        RABBITMQ_HOST: rabbitmq
                        STREAM_WS_PORT: 80
                        STREAM_HTTP_PORT: 3030
                        STREAM_QUEUE: pipes.stream
        mongo:
                image: 'mongo:3.4'
                volumes:
                        - 'mongo:/data/db'
        redis:
                image: 'redis:3.2-alpine'
                volumes:
                        - 'redis:/data'
        rabbitmq:
                image: 'rabbitmq:3-management-alpine'
                volumes:
                        - rabbitmq/var/lib/rabbitmq
volumes:
        mongo: {  }
        redis: {  }
        rabbitmq: {  }
