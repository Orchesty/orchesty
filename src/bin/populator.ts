import {Channel} from "amqplib";
import {Publisher} from "amqplib-plus/dist/lib/Publisher";
import * as fs from "fs";
import logger from "../logger/Logger";
import {IAmqpFaucetSettings} from "../node/faucet/AmqpFaucet";
import Pipes from "../Pipes";
import {ITopologyConfig} from "../topology/Configurator";

const POPULATOR_COUNT = parseInt(process.env.POPULATOR_COUNT, 10) || 1000;
const POPULATOR_BATCH = parseInt(process.env.POPULATOR_BATCH, 10) || 500;
const POPULATOR_BATCH_TIMEOUT = parseInt(process.env.POPULATOR_BATCH_TIMEOUT, 10) || 1000;
const POPULATOR_QUEUE = process.env.POPULATOR_QUEUE || "";

const loadTopologyConfigFromFile = (): ITopologyConfig => {
    try {
        return JSON.parse(fs.readFileSync("topology/topology.json", "utf8"));
    } catch (e) {
        logger.error("Cannot start program: ", {error: e});
        process.exit(126);
    }
};

const pipes = new Pipes(loadTopologyConfigFromFile());
const firstFaucet: IAmqpFaucetSettings = pipes.getTopologyConfig(true).nodes[0].faucet.settings;
const inQueue = firstFaucet.queue;

if (POPULATOR_QUEUE !== "") {
    inQueue.name = POPULATOR_QUEUE;
}

logger.info(`Populator will publish ${POPULATOR_COUNT} messages to ${firstFaucet.queue.name}`);

const conn = pipes.getDIContainer().get("amqp.connection");
const publisher = new Publisher(conn, async (ch: Channel) => {
    await ch.assertQueue(inQueue.name, inQueue.options);
});

for (let i = 1; i <= POPULATOR_COUNT; i++) {
    setTimeout(() => {
        sendMessage(i);
    }, Math.floor(i / POPULATOR_BATCH) * POPULATOR_BATCH_TIMEOUT);
}

// const content = JSON.stringify({
//     event: "data",
//     data: JSON.stringify({
//         bids: [],
//         asks: [],
//     }),
// });

const content = JSON.stringify({
    bids: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nam rhoncus odio eu urna pharetra, id rhoncus mauris molestie. Duis ultrices, sem in iaculis hendrerit, ligula lacus eleifend orci, a facilisis turpis ligula quis purus. Phasellus ut nisl sodales, pharetra nunc sit amet, ornare purus. Morbi egestas magna quis vulputate porta. Vestibulum tristique, nulla eget sagittis varius, justo neque gravida ex, vel blandit lacus mauris posuere diam. Pellentesque quis odio in dolor luctus fermentum nec a sapien. Ut molestie enim at volutpat lacinia. In blandit, tortor pellentesque congue commodo, eros massa tempus mi, non dignissim purus sem ut neque. Suspendisse in convallis sapien. Aliquam erat volutpat. Donec sollicitudin finibus justo in tristique. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Suspendisse mattis, est sit amet rutrum auctor, orci nisl posuere ligula, quis tristique sem risus ut ligula. Interdum et malesuada fames ac ante ipsum primis in faucibus. Maecenas scelerisque risus vel dui ornare, sit amet faucibus nulla congue. Aliquam erat volutpat. Donec a nunc nec lacus rutrum rutrum. Interdum et malesuada fames ac ante ipsum primis in faucibus. Integer vulputate auctor enim sed consectetur. Integer lobortis non felis nec imperdiet Sed molestie porttitor mollis. Cras consectetur enim ut sapien luctus eleifend. Sed scelerisque consectetur neque, quis tempor mauris malesuada eget. Donec tristique, orci non congue hendrerit, orci leo accumsan nisi, eu tristique dui massa nec mauris. Mauris et nunc quis felis ullamcorper volutpat. Sed enim mi, maximus ac blandit ac, dignissim eget nunc. Vivamus ut magna sem. Phasellus hendrerit leo vitae enim auctor fermentum. Maecenas lorem nisi, accumsan in eros ut, lobortis convallis libero. Duis placerat odio sed odio vehicula, sit amet fringilla diam sollicitudin. Vestibulum varius laoreet justo, non consectetur odio convallis sit amet. Phasellus et massa egestas, tristique massa vel, fringilla ipsum. Sed dapibus tincidunt luctus. Vestibulum fringilla mattis turpis, nec vulputate nunc varius vitae. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut a velit sapien. Donec efficitur risus sit amet convallis rutrum Sed sed dignissim turpis, ac sollicitudin mauris. Nam augue diam, iaculis rhoncus aliquam et, blandit a nisi. Nullam posuere ut urna sed vehicula. Vivamus dignissim, ligula sed sagittis maximus, lacus lorem rhoncus ipsum, vel tristique tortor elit ac purus. Nam in lacus ut leo condimentum convallis eget sit amet tortor. Quisque consequat velit nec mollis egestas. Suspendisse mi lacus, rutrum a viverra a, cursus eu metus. Suspendisse aliquet tortor eu velit sollicitudin commodo. Mauris mattis felis vel dui pulvinar, at dictum massa posuere. Ut laoreet pulvinar ex, in gravida augue vulputate in. Etiam viverra, ipsum et tincidunt pretium, velit diam sollicitudin nibh, sit amet ultricies velit eros vitae nibh. Donec gravida facilisis nulla efficitur dapibus. Curabitur sed leo sed lorem tincidunt rhoncus id sed nulla. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vivamus lobortis libero et lacinia mattis.",
    asks: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nam rhoncus odio eu urna pharetra, id rhoncus mauris molestie. Duis ultrices, sem in iaculis hendrerit, ligula lacus eleifend orci, a facilisis turpis ligula quis purus. Phasellus ut nisl sodales, pharetra nunc sit amet, ornare purus. Morbi egestas magna quis vulputate porta. Vestibulum tristique, nulla eget sagittis varius, justo neque gravida ex, vel blandit lacus mauris posuere diam. Pellentesque quis odio in dolor luctus fermentum nec a sapien. Ut molestie enim at volutpat lacinia. In blandit, tortor pellentesque congue commodo, eros massa tempus mi, non dignissim purus sem ut neque. Suspendisse in convallis sapien. Aliquam erat volutpat. Donec sollicitudin finibus justo in tristique. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Suspendisse mattis, est sit amet rutrum auctor, orci nisl posuere ligula, quis tristique sem risus ut ligula. Interdum et malesuada fames ac ante ipsum primis in faucibus. Maecenas scelerisque risus vel dui ornare, sit amet faucibus nulla congue. Aliquam erat volutpat. Donec a nunc nec lacus rutrum rutrum. Interdum et malesuada fames ac ante ipsum primis in faucibus. Integer vulputate auctor enim sed consectetur. Integer lobortis non felis nec imperdiet Sed molestie porttitor mollis. Cras consectetur enim ut sapien luctus eleifend. Sed scelerisque consectetur neque, quis tempor mauris malesuada eget. Donec tristique, orci non congue hendrerit, orci leo accumsan nisi, eu tristique dui massa nec mauris. Mauris et nunc quis felis ullamcorper volutpat. Sed enim mi, maximus ac blandit ac, dignissim eget nunc. Vivamus ut magna sem. Phasellus hendrerit leo vitae enim auctor fermentum. Maecenas lorem nisi, accumsan in eros ut, lobortis convallis libero. Duis placerat odio sed odio vehicula, sit amet fringilla diam sollicitudin. Vestibulum varius laoreet justo, non consectetur odio convallis sit amet. Phasellus et massa egestas, tristique massa vel, fringilla ipsum. Sed dapibus tincidunt luctus. Vestibulum fringilla mattis turpis, nec vulputate nunc varius vitae. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut a velit sapien. Donec efficitur risus sit amet convallis rutrum Sed sed dignissim turpis, ac sollicitudin mauris. Nam augue diam, iaculis rhoncus aliquam et, blandit a nisi. Nullam posuere ut urna sed vehicula. Vivamus dignissim, ligula sed sagittis maximus, lacus lorem rhoncus ipsum, vel tristique tortor elit ac purus. Nam in lacus ut leo condimentum convallis eget sit amet tortor. Quisque consequat velit nec mollis egestas. Suspendisse mi lacus, rutrum a viverra a, cursus eu metus. Suspendisse aliquet tortor eu velit sollicitudin commodo. Mauris mattis felis vel dui pulvinar, at dictum massa posuere. Ut laoreet pulvinar ex, in gravida augue vulputate in. Etiam viverra, ipsum et tincidunt pretium, velit diam sollicitudin nibh, sit amet ultricies velit eros vitae nibh. Donec gravida facilisis nulla efficitur dapibus. Curabitur sed leo sed lorem tincidunt rhoncus id sed nulla. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vivamus lobortis libero et lacinia mattis.",
    foo: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nam rhoncus odio eu urna pharetra, id rhoncus mauris molestie. Duis ultrices, sem in iaculis hendrerit, ligula lacus eleifend orci, a facilisis turpis ligula quis purus. Phasellus ut nisl sodales, pharetra nunc sit amet, ornare purus. Morbi egestas magna quis vulputate porta. Vestibulum tristique, nulla eget sagittis varius, justo neque gravida ex, vel blandit lacus mauris posuere diam. Pellentesque quis odio in dolor luctus fermentum nec a sapien. Ut molestie enim at volutpat lacinia. In blandit, tortor pellentesque congue commodo, eros massa tempus mi, non dignissim purus sem ut neque. Suspendisse in convallis sapien. Aliquam erat volutpat. Donec sollicitudin finibus justo in tristique. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Suspendisse mattis, est sit amet rutrum auctor, orci nisl posuere ligula, quis tristique sem risus ut ligula. Interdum et malesuada fames ac ante ipsum primis in faucibus. Maecenas scelerisque risus vel dui ornare, sit amet faucibus nulla congue. Aliquam erat volutpat. Donec a nunc nec lacus rutrum rutrum. Interdum et malesuada fames ac ante ipsum primis in faucibus. Integer vulputate auctor enim sed consectetur. Integer lobortis non felis nec imperdiet Sed molestie porttitor mollis. Cras consectetur enim ut sapien luctus eleifend. Sed scelerisque consectetur neque, quis tempor mauris malesuada eget. Donec tristique, orci non congue hendrerit, orci leo accumsan nisi, eu tristique dui massa nec mauris. Mauris et nunc quis felis ullamcorper volutpat. Sed enim mi, maximus ac blandit ac, dignissim eget nunc. Vivamus ut magna sem. Phasellus hendrerit leo vitae enim auctor fermentum. Maecenas lorem nisi, accumsan in eros ut, lobortis convallis libero. Duis placerat odio sed odio vehicula, sit amet fringilla diam sollicitudin. Vestibulum varius laoreet justo, non consectetur odio convallis sit amet. Phasellus et massa egestas, tristique massa vel, fringilla ipsum. Sed dapibus tincidunt luctus. Vestibulum fringilla mattis turpis, nec vulputate nunc varius vitae. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut a velit sapien. Donec efficitur risus sit amet convallis rutrum Sed sed dignissim turpis, ac sollicitudin mauris. Nam augue diam, iaculis rhoncus aliquam et, blandit a nisi. Nullam posuere ut urna sed vehicula. Vivamus dignissim, ligula sed sagittis maximus, lacus lorem rhoncus ipsum, vel tristique tortor elit ac purus. Nam in lacus ut leo condimentum convallis eget sit amet tortor. Quisque consequat velit nec mollis egestas. Suspendisse mi lacus, rutrum a viverra a, cursus eu metus. Suspendisse aliquet tortor eu velit sollicitudin commodo. Mauris mattis felis vel dui pulvinar, at dictum massa posuere. Ut laoreet pulvinar ex, in gravida augue vulputate in. Etiam viverra, ipsum et tincidunt pretium, velit diam sollicitudin nibh, sit amet ultricies velit eros vitae nibh. Donec gravida facilisis nulla efficitur dapibus. Curabitur sed leo sed lorem tincidunt rhoncus id sed nulla. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vivamus lobortis libero et lacinia mattis. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nam rhoncus odio eu urna pharetra, id rhoncus mauris molestie. Duis ultrices, sem in iaculis hendrerit, ligula lacus eleifend orci, a facilisis turpis ligula quis purus. Phasellus ut nisl sodales, pharetra nunc sit amet, ornare purus. Morbi egestas magna quis vulputate porta. Vestibulum tristique, nulla eget sagittis varius, justo neque gravida ex, vel blandit lacus mauris posuere diam. Pellentesque quis odio in dolor luctus fermentum nec a sapien. Ut molestie enim at volutpat lacinia. In blandit, tortor pellentesque congue commodo, eros massa tempus mi, non dignissim purus sem ut neque. Suspendisse in convallis sapien. Aliquam erat volutpat. Donec sollicitudin finibus justo in tristique. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Suspendisse mattis, est sit amet rutrum auctor, orci nisl posuere ligula, quis tristique sem risus ut ligula. Interdum et malesuada fames ac ante ipsum primis in faucibus. Maecenas scelerisque risus vel dui ornare, sit amet faucibus nulla congue. Aliquam erat volutpat. Donec a nunc nec lacus rutrum rutrum. Interdum et malesuada fames ac ante ipsum primis in faucibus. Integer vulputate auctor enim sed consectetur. Integer lobortis non felis nec imperdiet Sed molestie porttitor mollis. Cras consectetur enim ut sapien luctus eleifend. Sed scelerisque consectetur neque, quis tempor mauris malesuada eget. Donec tristique, orci non congue hendrerit, orci leo accumsan nisi, eu tristique dui massa nec mauris. Mauris et nunc quis felis ullamcorper volutpat. Sed enim mi, maximus ac blandit ac, dignissim eget nunc. Vivamus ut magna sem. Phasellus hendrerit leo vitae enim auctor fermentum. Maecenas lorem nisi, accumsan in eros ut, lobortis convallis libero. Duis placerat odio sed odio vehicula, sit amet fringilla diam sollicitudin. Vestibulum varius laoreet justo, non consectetur odio convallis sit amet. Phasellus et massa egestas, tristique massa vel, fringilla ipsum. Sed dapibus tincidunt luctus. Vestibulum fringilla mattis turpis, nec vulputate nunc varius vitae. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut a velit sapien. Donec efficitur risus sit amet convallis rutrum Sed sed dignissim turpis, ac sollicitudin mauris. Nam augue diam, iaculis rhoncus aliquam et, blandit a nisi. Nullam posuere ut urna sed vehicula. Vivamus dignissim, ligula sed sagittis maximus, lacus lorem rhoncus ipsum, vel tristique tortor elit ac purus. Nam in lacus ut leo condimentum convallis eget sit amet tortor. Quisque consequat velit nec mollis egestas. Suspendisse mi lacus, rutrum a viverra a, cursus eu metus. Suspendisse aliquet tortor eu velit sollicitudin commodo. Mauris mattis felis vel dui pulvinar, at dictum massa posuere. Ut laoreet pulvinar ex, in gravida augue vulputate in. Etiam viverra, ipsum et tincidunt pretium, velit diam sollicitudin nibh, sit amet ultricies velit eros vitae nibh. Donec gravida facilisis nulla efficitur dapibus. Curabitur sed leo sed lorem tincidunt rhoncus id sed nulla. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vivamus lobortis libero et lacinia mattis.",
    bar: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nam rhoncus odio eu urna pharetra, id rhoncus mauris molestie. Duis ultrices, sem in iaculis hendrerit, ligula lacus eleifend orci, a facilisis turpis ligula quis purus. Phasellus ut nisl sodales, pharetra nunc sit amet, ornare purus. Morbi egestas magna quis vulputate porta. Vestibulum tristique, nulla eget sagittis varius, justo neque gravida ex, vel blandit lacus mauris posuere diam. Pellentesque quis odio in dolor luctus fermentum nec a sapien. Ut molestie enim at volutpat lacinia. In blandit, tortor pellentesque congue commodo, eros massa tempus mi, non dignissim purus sem ut neque. Suspendisse in convallis sapien. Aliquam erat volutpat. Donec sollicitudin finibus justo in tristique. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Suspendisse mattis, est sit amet rutrum auctor, orci nisl posuere ligula, quis tristique sem risus ut ligula. Interdum et malesuada fames ac ante ipsum primis in faucibus. Maecenas scelerisque risus vel dui ornare, sit amet faucibus nulla congue. Aliquam erat volutpat. Donec a nunc nec lacus rutrum rutrum. Interdum et malesuada fames ac ante ipsum primis in faucibus. Integer vulputate auctor enim sed consectetur. Integer lobortis non felis nec imperdiet Sed molestie porttitor mollis. Cras consectetur enim ut sapien luctus eleifend. Sed scelerisque consectetur neque, quis tempor mauris malesuada eget. Donec tristique, orci non congue hendrerit, orci leo accumsan nisi, eu tristique dui massa nec mauris. Mauris et nunc quis felis ullamcorper volutpat. Sed enim mi, maximus ac blandit ac, dignissim eget nunc. Vivamus ut magna sem. Phasellus hendrerit leo vitae enim auctor fermentum. Maecenas lorem nisi, accumsan in eros ut, lobortis convallis libero. Duis placerat odio sed odio vehicula, sit amet fringilla diam sollicitudin. Vestibulum varius laoreet justo, non consectetur odio convallis sit amet. Phasellus et massa egestas, tristique massa vel, fringilla ipsum. Sed dapibus tincidunt luctus. Vestibulum fringilla mattis turpis, nec vulputate nunc varius vitae. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut a velit sapien. Donec efficitur risus sit amet convallis rutrum Sed sed dignissim turpis, ac sollicitudin mauris. Nam augue diam, iaculis rhoncus aliquam et, blandit a nisi. Nullam posuere ut urna sed vehicula. Vivamus dignissim, ligula sed sagittis maximus, lacus lorem rhoncus ipsum, vel tristique tortor elit ac purus. Nam in lacus ut leo condimentum convallis eget sit amet tortor. Quisque consequat velit nec mollis egestas. Suspendisse mi lacus, rutrum a viverra a, cursus eu metus. Suspendisse aliquet tortor eu velit sollicitudin commodo. Mauris mattis felis vel dui pulvinar, at dictum massa posuere. Ut laoreet pulvinar ex, in gravida augue vulputate in. Etiam viverra, ipsum et tincidunt pretium, velit diam sollicitudin nibh, sit amet ultricies velit eros vitae nibh. Donec gravida facilisis nulla efficitur dapibus. Curabitur sed leo sed lorem tincidunt rhoncus id sed nulla. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vivamus lobortis libero et lacinia mattis. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nam rhoncus odio eu urna pharetra, id rhoncus mauris molestie. Duis ultrices, sem in iaculis hendrerit, ligula lacus eleifend orci, a facilisis turpis ligula quis purus. Phasellus ut nisl sodales, pharetra nunc sit amet, ornare purus. Morbi egestas magna quis vulputate porta. Vestibulum tristique, nulla eget sagittis varius, justo neque gravida ex, vel blandit lacus mauris posuere diam. Pellentesque quis odio in dolor luctus fermentum nec a sapien. Ut molestie enim at volutpat lacinia. In blandit, tortor pellentesque congue commodo, eros massa tempus mi, non dignissim purus sem ut neque. Suspendisse in convallis sapien. Aliquam erat volutpat. Donec sollicitudin finibus justo in tristique. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Suspendisse mattis, est sit amet rutrum auctor, orci nisl posuere ligula, quis tristique sem risus ut ligula. Interdum et malesuada fames ac ante ipsum primis in faucibus. Maecenas scelerisque risus vel dui ornare, sit amet faucibus nulla congue. Aliquam erat volutpat. Donec a nunc nec lacus rutrum rutrum. Interdum et malesuada fames ac ante ipsum primis in faucibus. Integer vulputate auctor enim sed consectetur. Integer lobortis non felis nec imperdiet Sed molestie porttitor mollis. Cras consectetur enim ut sapien luctus eleifend. Sed scelerisque consectetur neque, quis tempor mauris malesuada eget. Donec tristique, orci non congue hendrerit, orci leo accumsan nisi, eu tristique dui massa nec mauris. Mauris et nunc quis felis ullamcorper volutpat. Sed enim mi, maximus ac blandit ac, dignissim eget nunc. Vivamus ut magna sem. Phasellus hendrerit leo vitae enim auctor fermentum. Maecenas lorem nisi, accumsan in eros ut, lobortis convallis libero. Duis placerat odio sed odio vehicula, sit amet fringilla diam sollicitudin. Vestibulum varius laoreet justo, non consectetur odio convallis sit amet. Phasellus et massa egestas, tristique massa vel, fringilla ipsum. Sed dapibus tincidunt luctus. Vestibulum fringilla mattis turpis, nec vulputate nunc varius vitae. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut a velit sapien. Donec efficitur risus sit amet convallis rutrum Sed sed dignissim turpis, ac sollicitudin mauris. Nam augue diam, iaculis rhoncus aliquam et, blandit a nisi. Nullam posuere ut urna sed vehicula. Vivamus dignissim, ligula sed sagittis maximus, lacus lorem rhoncus ipsum, vel tristique tortor elit ac purus. Nam in lacus ut leo condimentum convallis eget sit amet tortor. Quisque consequat velit nec mollis egestas. Suspendisse mi lacus, rutrum a viverra a, cursus eu metus. Suspendisse aliquet tortor eu velit sollicitudin commodo. Mauris mattis felis vel dui pulvinar, at dictum massa posuere. Ut laoreet pulvinar ex, in gravida augue vulputate in. Etiam viverra, ipsum et tincidunt pretium, velit diam sollicitudin nibh, sit amet ultricies velit eros vitae nibh. Donec gravida facilisis nulla efficitur dapibus. Curabitur sed leo sed lorem tincidunt rhoncus id sed nulla. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vivamus lobortis libero et lacinia mattis.",
});

const sendMessage = (i: number) => {
    publisher.sendToQueue(
        inQueue.name,
        new Buffer(content),
        {
            headers: {
                "pf-correlation-id" : `corr-${i}`,
                "pf-process-id": `process-${i}`,
                "pf-parent-id": "",
                "pf-sequence-id": "1",
                "pf-topology-id": "topo-id",
            },
        },
    ).then(() => {
        logger.info(`#${i} populator message sent to ${inQueue.name}.`);
    });
};

// In 5s after the last batch everything should be published
setTimeout(() => { process.exit(0); }, (Math.floor(POPULATOR_COUNT / POPULATOR_BATCH) + 5) * POPULATOR_BATCH_TIMEOUT);
